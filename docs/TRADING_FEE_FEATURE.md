# BTCDOM2.0 策略交易手续费功能说明

## 功能概述

在 BTCDOM2.0 策略回测系统中新增了交易手续费功能，用于更准确地模拟实际交易中的成本，提高回测结果的真实性。

## 新增功能

### 1. 高级参数 - 交易手续费率

- **位置**: 策略参数设置 → 高级参数 → 交易手续费率
- **默认值**: 0.2% (0.002)
- **取值范围**: 0% - 1%
- **计算方式**: 按交易金额收取

### 2. 持仓历史分析增强

#### 2.1 汇总信息新增字段

在持仓历史分析的汇总信息栏中新增：
- **当期手续费**: 显示当前期间发生的交易手续费总额
- **累计手续费**: 显示从策略开始到当前期间的累计手续费总额

#### 2.2 持仓表格新增手续费列

在每个资产的持仓详情中新增：
- **手续费列**: 显示该资产在当期产生的交易手续费
- **已卖出标识**: 对于在当期卖出的资产，会特别标注"已卖出"状态

#### 2.3 卖出持仓显示

- 系统会显示在当期卖出的所有持仓
- 卖出的持仓会显示最终的盈亏情况和产生的手续费
- 卖出原因会在备注列中说明

## 手续费计算逻辑

### 1. 手续费触发场景

以下情况会产生交易手续费：

1. **新增持仓**: 首次买入任何资产
2. **调整仓位**: BTC 或做空标的数量发生变化
3. **卖出持仓**: 
   - 做空标的不再符合条件被卖出
   - 策略转为空仓状态，全部持仓被卖出
4. **重新平衡**: 每期重新平衡时的仓位调整

### 2. 手续费计算公式

```
手续费 = 交易金额 × 手续费率
```

其中：
- **交易金额** = 发生变化的仓位价值
- **手续费率** = 用户设定的费率（默认 0.2%）

### 3. 具体计算示例

#### 示例 1: BTC 仓位调整
```
上期 BTC 持有: 1.0 BTC @ $50,000 = $50,000
本期 BTC 目标: 1.1 BTC @ $51,000 = $56,100

交易金额 = |1.1 - 1.0| × $51,000 = $5,100
手续费 = $5,100 × 0.002 = $10.20
```

#### 示例 2: 做空标的卖出
```
持有 ETHUSDT 做空仓位: $10,000
当期 ETH 价格从 $3,000 涨到 $3,100

卖出金额 = $10,000 / $3,000 × $3,100 = $10,333.33
手续费 = $10,333.33 × 0.002 = $20.67
```

## 对策略收益的影响

### 1. 总资产计算

新的总资产计算公式：
```
总资产 = 上期总资产 + BTC盈亏 + 做空盈亏 + 卖出盈亏 - 当期手续费
```

### 2. 收益率计算

手续费会直接影响策略的总收益率：
```
策略收益率 = (总资产 - 初始本金) / 初始本金
累计手续费率 = 累计手续费 / 初始本金
```

### 3. 性能指标影响

所有性能指标（夏普比率、最大回撤、年化收益率等）都会考虑手续费的影响，使回测结果更接近实际交易表现。

## 界面展示说明

### 1. 持仓状态标识

- **🔵 新增**: 本期新开仓的持仓
- **🟢 增加**: 本期增加仓位的持仓  
- **🔴 减少**: 本期减少仓位的持仓
- **⚫ 已卖出**: 本期完全卖出的持仓
- **➖ 无变化**: 仓位无变化的持仓

### 2. 手续费颜色说明

- **橙色**: 当期手续费
- **深橙色**: 累计手续费

### 3. 卖出持仓显示

卖出的持仓会：
- 显示"已卖出"标签
- 展示卖出时的价格
- 计算最终盈亏（包含手续费）
- 在备注中说明卖出原因

## 使用建议

### 1. 手续费率设置

- **现货交易**: 建议设置为 0.1% - 0.2%
- **期货交易**: 建议设置为 0.02% - 0.1% 
- **高频策略**: 建议设置为实际交易所费率

### 2. 策略优化

考虑手续费后，可以：
- 评估策略的真实盈利能力
- 优化再平衡频率
- 调整仓位调整幅度
- 比较不同交易所的成本差异

### 3. 风险控制

- 监控累计手续费占总资产的比例
- 避免过度频繁的交易
- 在策略收益率计算中考虑交易成本

## 技术实现

### 1. 数据结构变更

```typescript
interface PositionInfo {
  // 原有字段...
  tradingFee: number;        // 当期交易手续费
  isSoldOut?: boolean;       // 是否在当期卖出
  quantityChange?: {
    type: 'new' | 'increase' | 'decrease' | 'same' | 'sold';
    // ...
  };
}

interface StrategySnapshot {
  // 原有字段...
  soldPositions?: PositionInfo[];    // 当期卖出的持仓列表
  totalTradingFee: number;           // 当期总手续费
  accumulatedTradingFee: number;     // 累计总手续费
}
```

### 2. 计算逻辑

手续费计算被集成到策略引擎的每个重新平衡步骤中，确保：
- 准确捕获所有交易场景
- 正确计算仓位变化产生的费用
- 及时更新累计手续费统计

## 注意事项

1. **精度处理**: 数量变化小于 0.0001 的调整不计算手续费（避免浮点数精度问题）
2. **费率限制**: 手续费率限制在 0-1% 范围内，防止设置错误
3. **显示优化**: 手续费金额使用橙色高亮显示，便于识别
4. **历史兼容**: 对于没有手续费数据的历史记录，默认显示为 $0.00

这个功能使 BTCDOM2.0 策略回测更加真实和实用，帮助用户更好地评估策略的实际表现。